/*! angular-storyboard 2015-08-02 */
var ONE_HOUR_IN_MILLIS=36e5,ONE_DAY_IN_MILLIS=864e5;Date.prototype.differenceInDays=function(a){var b=Math.round(Math.abs((this.getTime()-a.getTime())/ONE_DAY_IN_MILLIS));return b},Date.prototype.differenceInHours=function(a){var b=Math.round(Math.abs((this.getTime()-a.getTime())/ONE_HOUR_IN_MILLIS));return b},Date.prototype.addHours=function(a){return this.setHours(this.getHours()+a),this},angular.module("storyboard").controller("gridCtrl",function(a,b,c){a.gridWidth=0,a.numColumnsLikely=0,a.renameStorylines=!1,a.sortableOptions={axis:"y","ui-floating":!0,placeholder:"highlight",start:function(b,c){a.storyboardData.gridEvents=[],a.$apply(),c.item.toggleClass("highlight")},stop:function(b,c){f(),p(),c.item.toggleClass("highlight"),a.$emit("reorderStorylines",a.storyboardData.storylines)}},a.initializeGridAndStorylines=function(){d(),f(),p()},a.$on("recalculateStoryboard",function(){console.log("**** Recalculate grid"),a.initializeGridAndStorylines()});var d=function(){a.storyboardData.storylines=a.options.storylines?a.options.storylines:[];for(var b={},c=0;c<a.options.storyboardEvents.length;c++){var d=a.options.storyboardEvents[c],f=d.storylineName?d.storylineName:"_undefined";b.hasOwnProperty(f)||(b[f]={overlapDepth:0,events:[]}),b[f].overlapDepth=Math.max(b[f].overlapDepth,e(d,b[f].events)),b[f].events.push(d)}for(var g in b)"_undefined"!=g&&-1==a.storyboardData.storylines.indexOf(g)&&a.storyboardData.storylines.push(g);b._undefined&&-1==a.storyboardData.storylines.indexOf("_undefined")&&a.storyboardData.storylines.push("_undefined")},e=function(a,b){for(var c=0,d=0;d<b.length;d++){var e=b[d];a!=e&&a.startDate>=e.startDate&&a.startDate<=e.endDate&&c++}return c},f=function(){j(),k(),q()};a.gridsterOpts={minRows:1,maxRows:100,maxSizeY:1,minSizeX:1,width:"auto",pushing:!1,floating:!1,swapping:!1,colWidth:100,rowHeight:180,margins:[35,10],defaultSizeX:1,defaultSizeY:1,mobileBreakPoint:600,resizable:{enabled:!0,start:function(){},resize:function(){},stop:function(a,b,c){g(c)}},draggable:{enabled:!0,handle:".my-class",start:function(){},drag:function(){},stop:function(a,b,c){h(c)}}};var g=function(b){b.event.endDate=o(b.col+b.sizeX),a.$emit("storyboardItemResized",b.event)},h=function(b){var c=(b.event.endDate.differenceInHours(b.event.startDate),b.row),d=b.col;b.event.storylineName=a.storyboardData.storylines[c],b.event.startDate=o(d),b.event.endDate=o(d+b.sizeX),i(b)&&a.$emit("triggerRecalculateStoryboard"),a.$emit("storyboardItemMoved",b.event)},i=function(b){var c=!1;return a.options.extendBeyondInHours&&a.options.extendBeyondInHours>0&&(a.options.gridSizeInHours*b.col<a.options.extendBeyondInHours||a.gridsterOpts.columns-b.col<a.options.extendBeyondInHours)&&(c=!0),c},j=function(){var b=Math.floor(a.storyboardData.maxDate.differenceInHours(a.storyboardData.minDate)/a.options.gridSizeInHours);a.gridsterOpts.columns=b,a.numColumnsLikely=b,a.gridsterOpts.colWidth=100,a.gridWidth=a.numColumnsLikely*a.gridsterOpts.colWidth,a.gridsterOpts.width=a.gridWidth,a.gridsterOpts.resizable.enabled=a.options.enableEditStoylineEvents,a.gridsterOpts.draggable.enabled=a.options.enableEditStoylineEvents},k=function(){a.storyboardData.gridEvents=[];for(var b=0;b<a.options.storyboardEvents.length;b++)l(a.options.storyboardEvents[b])},l=function(b){var c={};return c.event=b,c.sizeX=m(c.event.startDate,c.event.endDate),c.sizeY=1,c.dragEnabled=!1,c.row=a.storyboardData.storylines.indexOf(b.storylineName?b.storylineName:"_undefined"),c.col=n(c.event.startDate),a.storyboardData.gridEvents.push(c),c},m=function(b,c){return Math.floor(c.differenceInHours(b)/a.options.gridSizeInHours)},n=function(b){var c=Math.floor(b.differenceInHours(a.storyboardData.minDate)),d=c/a.options.gridSizeInHours;return d},o=function(b){var c=new Date;return c.setTime(a.storyboardData.minDate.getTime()),c.addHours(a.options.gridSizeInHours*b),c},p=function(){var b=a.storyboardData.maxViewDate.differenceInHours(a.storyboardData.minViewDate),d=document.getElementById("storyboardGridContainer").clientWidth,e=d/Math.floor(b/a.options.gridSizeInHours);a.gridsterOpts.colWidth=Math.floor(e),a.gridWidth=a.numColumnsLikely*a.gridsterOpts.colWidth,a.gridsterOpts.width=a.gridWidth;var f=a.storyboardData.maxDate.differenceInHours(a.storyboardData.minDate),g=a.storyboardData.minViewDate.differenceInHours(a.storyboardData.minDate),h=angular.element(document.getElementById("storyboardGridContainer")),i=g/f*a.gridWidth;c(function(){h.scrollLeft(i)},0)},q=function(){a.sliderMouseDown&&p()},r=_.throttle(q,5);a.$watch("storyboardData.minViewDate",r),a.$watch("storyboardData.maxViewDate",r),a.formatDate=function(a){return moment(a).format("MMM Do YYYY, h:mm:ss a")},a.showGridEventInView=function(b){return b.sizeX*a.gridsterOpts.colWidth<100?!1:!0};var s=angular.element(document.getElementById("storyboardGridContainer"));s.on("scroll",function(){u()});var t=function(){if(!a.sliderMouseDown){var b=document.getElementById("storyboardGrid"),c=b.clientWidth,d=s.scrollLeft(),e=d/c,f=a.storyboardData.maxDate.differenceInHours(a.storyboardData.minDate),g=e*f,h=a.storyboardData.maxViewDate.differenceInHours(a.storyboardData.minViewDate),i=new Date(a.storyboardData.minDate);i.addHours(g);var j=new Date(a.storyboardData.minDate);j.addHours(h+g),(i.getTime()!=a.storyboardData.minViewDate.getTime()||j.getTime()!=a.storyboardData.maxViewDate.getTime())&&(a.storyboardData.minViewDate=i,a.storyboardData.maxViewDate=j,a.$apply())}},u=_.debounce(t,1);a.doubleClick=function(b){if(a.options.enableEditStoylineEvents){var c=(document.getElementById("storyboardGrid"),void 0===b.offsetX?b.originalEvent.layerX:b.offsetX),d=void 0===b.offsetY?b.originalEvent.layerY:b.offsetY,e=Math.floor(d/180),f=Math.floor(c/a.gridsterOpts.colWidth),g=m(a.storyboardData.minViewDate,a.storyboardData.maxViewDate),h={startDate:o(f),endDate:o(f+Math.round(g/5)),title:"new event",storylineName:a.storyboardData.storylines[e]};a.options.storyboardEvents.push(h),a.$emit("storyboardItemAdded",h);var j=l(h,e);i(j)&&a.$emit("triggerRecalculateStoryboard")}},a.updateStorylineName=function(b,c){if(a.options.enableEditStoylineEvents){var d=a.storyboardData.storylines.indexOf(b);d>-1&&(a.storyboardData.storylines[d]=c);for(var e=0;e<a.options.storyboardEvents.length;e++){var f=a.options.storyboardEvents[e];f.storylineName==b&&(f.storylineName=c)}return a.$emit("storylineChanged",b,c),!0}},a.addStoryline=function(){if(a.options.enableEditStoylineEvents){var b="NewStoryline_"+(Math.random()+1).toString(36).substring(2,7);a.storyboardData.storylines.push(b);var c=n(a.storyboardData.minViewDate),d=m(a.storyboardData.minViewDate,a.storyboardData.maxViewDate),e={startDate:o(c),endDate:o(c+Math.round(d/5)),title:"new event",storylineName:b};a.options.storyboardEvents.push(e),l(e,a.storyboardData.storylines-1),a.$emit("addStoryline",b),a.$emit("storyboardItemAdded",e)}},a.deleteStoryline=function(b){if(a.options.enableEditStoylineEvents){for(var c=0;c<a.options.storyboardEvents.length;c++){var d=a.options.storyboardEvents[c];if(d.storylineName==b)return void alert("Cannot delete storyline while any events are still attached to it.  Delete or move any events to another storyline first.")}var e=a.storyboardData.storylines.indexOf(b);e>-1&&(a.storyboardData.storylines.splice(e,1),k(),a.$emit("deleteStoryline",b))}};var v=function(){},w=function(a,b){for(var c=0;c<b.length;c++)if(findIndex=a.indexOf(b[c].event),-1==findIndex){b.splice(c,1);break}},x=function(){var b=$.map(a.storyboardData.gridEvents,function(a){return a.event});0===$(a.options.storyboardEvents).not(b).length&&0===$(b).not(a.options.storyboardEvents).length||(v(a.options.storyboardEvents,a.storyboardData.gridEvents),w(a.options.storyboardEvents,a.storyboardData.gridEvents))},y=function(a,b){_.debounce(500,x(a,b),!0)};a.$watchCollection("options.storyboardEvents",y);var z=function(b,c){0===$(b).not(c).length&&0===$(c).not(b).length||a.$emit("triggerRecalculateStoryboard")};a.$watchCollection("options.storylines",z),a.createArray=function(a){return new Array(a)}});var storyboardModule=angular.module("storyboard",["storyboard-templates","jqrange-slider","gridster","duScroll","ui.sortable"]);storyboardModule.directive("storyboard",function(){return{restrict:"E",require:["options"],scope:{options:"="},templateUrl:"storyboard-template.html",controller:["$scope",function(a){a.storyboardData={}}],link:function(a){a.$watch("iAttrs.options.storyboardEvents",function(){}),a.$watch("iAttrs.options.storyboardEventTemplate",function(){}),a.$watch("iAttrs.options.smallStoryboardEventTemplate",function(){})}}}),storyboardModule.directive("options",function(){return{controller:function(){}}}),angular.module("storyboard").controller("sliderCtrl",function(a){a.timelineSliderOptions={type:"date",jqOptions:{bounds:{},formatter:function(a){return moment(a).format("LLL")},range:{min:{hours:4}},step:{hours:1}},selectedRange:{}},a.initializeSlider=function(){b()},a.$on("recalculateStoryboard",function(){console.log("***** slider recalculating"),a.initializeSlider()});var b=function(){a.timelineSliderOptions.jqOptions.bounds={min:a.storyboardData.minDate,max:a.storyboardData.maxDate},a.timelineSliderOptions.selectedRange={min:a.storyboardData.minViewDate,max:a.storyboardData.maxViewDate}},c=angular.element(document.getElementById("jqSlider"));c.bind("valuesChanging",function(b,c){a.storyboardData.minViewDate=c.values.min,a.storyboardData.maxViewDate=c.values.max,a.$apply()});var d=function(){a.storyboardData.minViewDate=a.timelineSliderOptions.selectedRange.min,a.storyboardData.maxViewDate=a.timelineSliderOptions.selectedRange.max,a.$apply()},e=_.debounce(d,10);a.$watch("timelineSliderOptions.selectedRange.min",e),a.$watch("timelineSliderOptions.selectedRange.max",e);var f=function(){a.sliderMouseDown||(a.timelineSliderOptions.selectedRange={min:a.storyboardData.minViewDate,max:a.storyboardData.maxViewDate},a.$apply())},g=_.debounce(f,2);a.$watch("storyboardData.minViewDate",g),a.$watch("storyboardData.maxViewDate",g),a.$watch("storyboardData.minDate",b)}),angular.module("storyboard").controller("storyboardCtrl",function(a){a.storyboardData={minDate:null,maxDate:null,minViewDate:null,maxViewDate:null,storylines:[],gridEvents:[]},a.initializeStoryboard=function(){b()};var b=function(){var b=a.options.storyboardEvents.length;if(b>0)for(var c=0;b>c;c++){var d=a.options.storyboardEvents[c];d.startDate.setMinutes(0,0,0),d.endDate.setMinutes(0,0,0),0==c&&(a.storyboardData.minDate=new Date(a.options.storyboardEvents[c].startDate),a.storyboardData.maxDate=new Date(a.options.storyboardEvents[c].startDate)),new Date(a.options.storyboardEvents[c].startDate)<a.storyboardData.minDate&&(a.storyboardData.minDate=new Date(a.options.storyboardEvents[c].startDate)),new Date(a.options.storyboardEvents[c].endDate)>a.storyboardData.maxDate&&(a.storyboardData.maxDate=new Date(a.options.storyboardEvents[c].endDate))}else a.storyboardData.minDate=(new Date).addHours(-48),a.storyboardData.maxDate=(new Date).addHours(48);a.storyboardData.minDate.addHours(-48),a.storyboardData.maxDate.addHours(48),a.storyboardData.minViewDate=new Date(a.storyboardData.minDate).addHours(48),a.storyboardData.maxViewDate=new Date((a.storyboardData.maxDate-a.storyboardData.minDate)/5+a.storyboardData.minDate.getTime()+1e6).addHours(48),a.storyboardData.maxViewDate>a.storyboardData.maxDate&&(a.storyboardData.maxViewDate=new Date(a.storyboardData.maxDate))};a.sliderMouseDown=!1;var c=angular.element(document.getElementById("jqSlider"));c.bind("mousestart",function(){a.sliderMouseDown=!0}),c.bind("stop",function(){a.sliderMouseDown=!1}),a.$on("triggerRecalculateStoryboard",function(){console.log("**************** TRIGGER RE_CALCULATE **************"),a.initializeStoryboard(),a.$broadcast("recalculateStoryboard")})});