/*! angular-storyboard 2015-06-24 */
var ONE_HOUR_IN_MILLIS=36e5,ONE_DAY_IN_MILLIS=864e5;Date.prototype.differenceInDays=function(a){var b=Math.round(Math.abs((this.getTime()-a.getTime())/ONE_DAY_IN_MILLIS));return b},Date.prototype.differenceInHours=function(a){var b=Math.round(Math.abs((this.getTime()-a.getTime())/ONE_HOUR_IN_MILLIS));return b},Date.prototype.addHours=function(a){return this.setHours(this.getHours()+a),this},angular.module("storyboard").controller("gridCtrl",function(a){a.gridWidth=0,a.renameStorylines=!1,a.initializeStorylines=function(){b(),d(),n()},a.createArray=function(a){return new Array(a)};var b=function(){a.storyboardData.storylines=[];for(var b={},d=0;d<a.options.storyboardEvents.length;d++){var e=a.options.storyboardEvents[d];e.startDate=new Date(e.startDate),e.endDate=new Date(e.endDate);var f=e.storyline?e.storyline:"_undefined";b.hasOwnProperty(f)||(b[f]={overlapDepth:0,events:[]}),b[f].overlapDepth=Math.max(b[f].overlapDepth,c(e,b[f].events)),b[f].events.push(e)}for(var g in b)"_undefined"!=g&&a.storyboardData.storylines.push(g);b._undefined&&a.storyboardData.storylines.push("_undefined")},c=function(a,b){for(var c=0,d=0;d<b.length;d++){var e=b[d];a!=e&&a.startDate>=e.startDate&&a.startDate<=e.endDate&&c++}return c},d=function(){h(),i(),o()};a.gridsterOpts={minRows:1,maxRows:100,maxSizeY:1,minSizeX:1,width:0,pushing:!1,floating:!1,swapping:!1,columns:2,colWidth:100,rowHeight:180,margins:[35,10],defaultSizeX:1,defaultSizeY:1,mobileBreakPoint:600,resizable:{enabled:!0,start:function(){},resize:function(){},stop:function(a,b,c){e(c)}},draggable:{enabled:!0,handle:".my-class",start:function(){},drag:function(){},stop:function(a,b,c){f(c)}}};var e=function(a){a.event.endDate=m(a.col+a.sizeX)},f=function(b){var c=(b.event.endDate.differenceInHours(b.event.startDate),b.row),d=b.col;b.event.storyline=a.storyboardData.storylines[c],b.event.startDate=m(d),b.event.endDate=m(d+b.sizeX),g(b)&&(a.$emit("recalculateStoryboard"),a.initializeStorylines())},g=function(b){var c=!1;return a.options.extendBeyondInHours&&a.options.extendBeyondInHours>0&&(a.options.gridSizeInHours*b.col<a.options.extendBeyondInHours||a.gridsterOpts.columns-b.col<a.options.extendBeyondInHours)&&(c=!0),c},h=function(){var b=Math.floor(a.storyboardData.maxDate.differenceInHours(a.storyboardData.minDate)/a.options.gridSizeInHours);a.gridsterOpts.columns=b,a.gridsterOpts.colWidth=100,a.gridWidth=a.gridsterOpts.columns*a.gridsterOpts.colWidth,a.gridsterOpts.width=a.gridWidth,console.log("columns = "+a.gridsterOpts.columns),console.log("grid width = "+a.gridWidth)},i=function(){a.storyboardData.gridEvents=[];for(var b=0;b<a.options.storyboardEvents.length;b++)j(a.options.storyboardEvents[b])},j=function(b){var c={};c.event=b,c.sizeX=k(c.event.startDate,c.event.endDate),c.sizeY=1,c.dragEnabled=!1,c.row=a.storyboardData.storylines.indexOf(b.storyline?b.storyline:"_undefined"),c.col=l(c.event.startDate),a.storyboardData.gridEvents.push(c)},k=function(b,c){return Math.floor(c.differenceInHours(b)/a.options.gridSizeInHours)},l=function(b){return Math.floor(b.differenceInHours(a.storyboardData.minDate)/a.options.gridSizeInHours)},m=function(b){var c=new Date;return c.setTime(a.storyboardData.minDate.getTime()),c.addHours(a.options.gridSizeInHours*b),c},n=function(){var b=a.storyboardData.maxViewDate.differenceInHours(a.storyboardData.minViewDate),c=document.getElementById("storyboardGridContainer").clientWidth,d=c/Math.floor(b/a.options.gridSizeInHours);a.gridsterOpts.colWidth=d,a.gridWidth=a.gridsterOpts.columns*a.gridsterOpts.colWidth;var e=a.storyboardData.maxDate.differenceInHours(a.storyboardData.minDate),f=a.storyboardData.minViewDate.differenceInHours(a.storyboardData.minDate),g=angular.element(document.getElementById("storyboardGridContainer")),h=f/e*a.gridWidth;g.scrollLeft(h)},o=function(){a.sliderMouseDown&&n()},p=_.throttle(o,5);a.$watch("storyboardData.minViewDate",p),a.$watch("storyboardData.maxViewDate",p),a.formatDate=function(a){return moment(a).format("MMM Do YYYY, h:mm:ss a")},a.showGridEventInView=function(b){return b.sizeX*a.gridsterOpts.colWidth<100?!1:!0};var q=angular.element(document.getElementById("storyboardGridContainer"));q.on("scroll",function(){s()});var r=function(){if(!a.sliderMouseDown){var b=document.getElementById("storyboardGrid"),c=b.clientWidth,d=q.scrollLeft(),e=d/c,f=a.storyboardData.maxDate.differenceInHours(a.storyboardData.minDate),g=e*f,h=a.storyboardData.maxViewDate.differenceInHours(a.storyboardData.minViewDate),i=new Date(a.storyboardData.minDate);i.addHours(g);var j=new Date(a.storyboardData.minDate);j.addHours(h+g),(i.getTime()!=a.storyboardData.minViewDate.getTime()||j.getTime()!=a.storyboardData.maxViewDate.getTime())&&(a.storyboardData.minViewDate=i,a.storyboardData.maxViewDate=j,a.$apply())}},s=_.debounce(r,1);a.doubleClick=function(b){var c=(document.getElementById("storyboardGrid"),Math.floor(b.offsetY/180)),d=Math.floor(b.offsetX/a.gridsterOpts.colWidth),e={startDate:m(d),endDate:m(d+1),title:"new event",storyline:a.storyboardData.storylines[c]};a.options.storyboardEvents.push(e),j(e,c)},a.updateStorylineName=function(b,c){for(var d=0;d<a.options.storyboardEvents.length;d++){var e=a.options.storyboardEvents[d];e.storyline==b&&(e.storyline=c)}return a.$emit("storylineChanged",b,c),!0};var t=function(){a.options.storyboardEvents.length!=a.storyboardData.gridEvents.length?console("Different"):console.log("Same")};a.$watchCollection("options.storyboardEvents",t)});var storyboardModule=angular.module("storyboard",["storyboard-templates","jqrange-slider","gridster","duScroll"]);storyboardModule.directive("storyboard",function(){return{restrict:"E",require:["options"],scope:{options:"="},templateUrl:"storyboard-template.html",controller:["$scope",function(a){a.storyboardData={}}],link:function(a){a.$watch("iAttrs.options.storyboardEvents",function(){}),a.$watch("iAttrs.options.storyboardEventTemplate",function(){}),a.$watch("iAttrs.options.smallStoryboardEventTemplate",function(){})}}}),storyboardModule.directive("options",function(){return{controller:function(){}}}),angular.module("storyboard").controller("sliderCtrl",function(a){a.timelineSliderOptions={type:"date",jqOptions:{bounds:{},formatter:function(a){return moment(a).format("LLL")},range:{min:{hours:4}},step:{hours:4}},selectedRange:{}},a.initializeSlider=function(){b()};var b=function(){console.log("createTimelineSliderData"),a.timelineSliderOptions.jqOptions.bounds={min:a.storyboardData.minDate,max:a.storyboardData.maxDate},a.timelineSliderOptions.selectedRange.min=a.storyboardData.minViewDate,a.timelineSliderOptions.selectedRange.max=a.storyboardData.maxViewDate},c=angular.element(document.getElementById("jqSlider"));c.bind("valuesChanging",function(b,c){a.storyboardData.minViewDate=c.values.min,a.storyboardData.maxViewDate=c.values.max,a.$apply()});var d=function(){a.storyboardData.minViewDate=a.timelineSliderOptions.selectedRange.min,a.storyboardData.maxViewDate=a.timelineSliderOptions.selectedRange.max,a.$apply()},e=_.debounce(d,10);a.$watch("timelineSliderOptions.selectedRange.min",e),a.$watch("timelineSliderOptions.selectedRange.max",e);var f=function(){a.sliderMouseDown||(a.timelineSliderOptions.selectedRange={min:a.storyboardData.minViewDate,max:a.storyboardData.maxViewDate},a.$apply())},g=_.debounce(f,2);a.$watch("storyboardData.minViewDate",g),a.$watch("storyboardData.maxViewDate",g),a.$watch("storyboardData.minDate",b)}),angular.module("storyboard").controller("storyboardCtrl",function(a){a.storyboardData={minDate:null,maxDate:null,minViewDate:null,maxViewDate:null,storylines:[],gridEvents:[]},a.initializeStoryboard=function(){b()};var b=function(){for(var b=a.options.storyboardEvents.length,c=0;b>c;c++)0==c&&(a.storyboardData.minDate=new Date(a.options.storyboardEvents[c].startDate),a.storyboardData.maxDate=new Date(a.options.storyboardEvents[c].startDate)),new Date(a.options.storyboardEvents[c].startDate)<a.storyboardData.minDate&&(a.storyboardData.minDate=new Date(a.options.storyboardEvents[c].startDate)),new Date(a.options.storyboardEvents[c].endDate)>a.storyboardData.maxDate&&(a.storyboardData.maxDate=new Date(a.options.storyboardEvents[c].endDate));a.storyboardData.minDate.setDate(a.storyboardData.minDate.getDate()-2),a.storyboardData.maxDate.setDate(a.storyboardData.maxDate.getDate()+2),a.storyboardData.minViewDate=new Date(a.storyboardData.minDate),a.storyboardData.maxViewDate=new Date((a.storyboardData.maxDate-a.storyboardData.minDate)/5+a.storyboardData.minDate.getTime()+1e6),console.log("minDate = "+a.storyboardData.minDate),console.log("maxDate = "+a.storyboardData.maxDate)};a.sliderMouseDown=!1;var c=angular.element(document.getElementById("jqSlider"));c.bind("mousestart",function(){a.sliderMouseDown=!0}),c.bind("stop",function(){a.sliderMouseDown=!1}),a.$on("recalculateStoryboard",b)});