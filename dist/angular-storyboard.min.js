/*! angular-storyboard 2015-05-19 */
var ONE_HOUR_IN_MILLIS=36e5,ONE_DAY_IN_MILLIS=864e5;Date.prototype.differenceInDays=function(a){var b=Math.round(Math.abs((this.getTime()-a.getTime())/ONE_DAY_IN_MILLIS));return b},Date.prototype.differenceInHours=function(a){var b=Math.round(Math.abs((this.getTime()-a.getTime())/ONE_HOUR_IN_MILLIS));return b},Date.prototype.addHours=function(a){return this.setHours(this.getHours()+a),this},angular.module("storyboard").controller("gridCtrl",function(a){a.gridWidth=0,a.gridCellHeight=180,a.data={storylines:[]},a.gridEvents=[],a.initializeStorylines=function(){b(),d()},a.createArray=function(a){return new Array(a)};var b=function(){for(var b={},d=0;d<a.storyboardEvents.length;d++){var e=a.storyboardEvents[d],f=e.storyline?e.storyline:"_undefined";b.hasOwnProperty(f)||(b[f]={overlapDepth:0,events:[]}),b[f].overlapDepth=Math.max(b[f].overlapDepth,c(e,b[f].events)),b[f].events.push(e)}for(var g in b)a.data.storylines.push({name:g,overlapDepth:b[g].overlapDepth,events:b[g].events})},c=function(a,b){for(var c=0,d=0;d<b.length;d++){var e=b[d];a!=e&&a.startDate>=e.startDate&&a.startDate<=e.endDate&&c++}return c},d=function(){g(),h(),k()};a.gridsterOpts={minRows:1,maxRows:100,maxSizeY:1,minSizeX:1,width:0,pushing:!1,floating:!1,swapping:!1,columns:2,colWidth:100,rowHeight:180,margins:[35,10],defaultSizeX:1,defaultSizeY:1,mobileBreakPoint:600,resizable:{enabled:!0,start:function(){},resize:function(){},stop:function(a,b,c){e(c)}},draggable:{enabled:!0,handle:".my-class",start:function(){},drag:function(){},stop:function(a,b,c){f(c)}}};var e=function(){},f=function(b){{var c=b.row;b.col}b.event.storyline=a.data.storylines[c].name},g=function(){var b=Math.floor(a.storyboardData.maxDate.differenceInHours(a.storyboardData.minDate)/4);a.gridsterOpts.columns=b,a.gridsterOpts.colWidth=100,a.gridWidth=a.gridsterOpts.columns*a.gridsterOpts.colWidth,a.gridsterOpts.width=a.gridWidth,console.log("columns = "+a.gridsterOpts.columns),console.log("grid width = "+a.gridWidth)},h=function(){for(var b=a.data.storylines.length,c=0,d=0;b>d;d++){for(var e=a.data.storylines[d].events,f=0;f<e.length;f++){var g={};g.event=e[f],g.sizeX=i(g.event.startDate,g.event.endDate),g.sizeY=1,g.dragEnabled=!1,g.row=c,g.col=j(g.event.startDate),a.gridEvents.push(g),console.log(g)}c+=a.data.storylines[d].overlapDepth+1}a.gridsterOpts.maxRows=c},i=function(a,b){return Math.floor(b.differenceInHours(a)/4)},j=function(b){return Math.floor(b.differenceInHours(a.storyboardData.minDate)/4)},k=function(){if(a.sliderMouseDown){var b=a.storyboardData.maxViewDate.differenceInHours(a.storyboardData.minViewDate),c=document.getElementById("storyboardGridContainer").clientWidth,d=c/Math.floor(b/4);a.gridsterOpts.colWidth=d,a.gridWidth=a.gridsterOpts.columns*a.gridsterOpts.colWidth;var e=a.storyboardData.maxDate.differenceInHours(a.storyboardData.minDate),f=a.storyboardData.minViewDate.differenceInHours(a.storyboardData.minDate),g=angular.element(document.getElementById("storyboardGridContainer")),h=f/e*a.gridWidth;g.scrollLeft(h)}},l=_.throttle(k,5);a.$watch("storyboardData.minViewDate",l),a.$watch("storyboardData.maxViewDate",l),a.formatDate=function(a){return moment(a).format("MMM Do YYYY, h:mm:ss a")},a.showGridEventInView=function(b){return b.sizeX*a.gridsterOpts.colWidth<100?!1:!0};var m=angular.element(document.getElementById("storyboardGridContainer"));m.on("scroll",function(){o()});var n=function(){if(!a.sliderMouseDown){var b=document.getElementById("storyboardGrid"),c=b.clientWidth,d=m.scrollLeft(),e=d/c,f=a.storyboardData.maxDate.differenceInHours(a.storyboardData.minDate),g=e*f,h=a.storyboardData.maxViewDate.differenceInHours(a.storyboardData.minViewDate),i=new Date(a.storyboardData.minDate);i.addHours(g);var j=new Date(a.storyboardData.minDate);j.addHours(h+g),(i.getTime()!=a.storyboardData.minViewDate.getTime()||j.getTime()!=a.storyboardData.maxViewDate.getTime())&&(a.storyboardData.minViewDate=i,a.storyboardData.maxViewDate=j,a.$apply())}},o=_.debounce(n,1)});var storyboardModule=angular.module("storyboard",["storyboard-templates","jqrange-slider","gridster","duScroll"]);storyboardModule.directive("storyboard",function(){return{restrict:"E",require:["storyboardEvents","storyboardEventTemplate"],scope:{storyboardEvents:"=",storyboardEventTemplate:"=",smallStoryboardEventTemplate:"="},templateUrl:"storyboard-template.html",controller:["$scope",function(a){a.storyboardData={}}],link:function(a,b,c){a.$watch("iAttrs.storyboardEvents",function(){}),a.$watch("iAttrs.storyboardEventTemplate",function(){a.storyboardItemTemplate=c.storyboardEventTemplate}),a.$watch("iAttrs.smallStoryboardEventTemplate",function(){a.smallStoryboardItemTemplate=c.smallStoryboardEventTemplate})}}}),storyboardModule.directive("storyboardEvents",function(){return{controller:function(){}}}),storyboardModule.directive("storyboardEventTemplate",function(){return{controller:function(){}}}),angular.module("storyboard").controller("sliderCtrl",function(a){a.timelineSliderOptions={type:"date",jqOptions:{bounds:{},formatter:function(a){return moment(a).format("LLL")},range:{min:{hours:4}},step:{hours:4}},selectedRange:{}},a.initializeSlider=function(){b()};var b=function(){a.timelineSliderOptions.jqOptions.bounds.min=a.storyboardData.minDate,a.timelineSliderOptions.jqOptions.bounds.max=a.storyboardData.maxDate,a.timelineSliderOptions.selectedRange.min=a.storyboardData.minViewDate,a.timelineSliderOptions.selectedRange.max=a.storyboardData.maxViewDate},c=angular.element(document.getElementById("jqSlider"));c.bind("valuesChanging",function(b,c){a.storyboardData.minViewDate=c.values.min,a.storyboardData.maxViewDate=c.values.max,a.$apply()});var d=function(){a.storyboardData.minViewDate=a.timelineSliderOptions.selectedRange.min,a.storyboardData.maxViewDate=a.timelineSliderOptions.selectedRange.max,a.$apply()},e=_.debounce(d,10);a.$watch("timelineSliderOptions.selectedRange.min",e),a.$watch("timelineSliderOptions.selectedRange.max",e);var f=function(){a.sliderMouseDown||(a.timelineSliderOptions.selectedRange={min:a.storyboardData.minViewDate,max:a.storyboardData.maxViewDate},a.$apply())},g=_.debounce(f,2);a.$watch("storyboardData.minViewDate",g),a.$watch("storyboardData.maxViewDate",g)}),angular.module("storyboard").controller("storyboardCtrl",function(a){a.storyboardData={minDate:null,maxDate:null,minViewDate:null,maxViewDate:null},a.initializeStoryboard=function(){b()};var b=function(){for(var b=a.storyboardEvents.length,c=0;b>c;c++)0==c&&(a.storyboardData.minDate=new Date(a.storyboardEvents[c].startDate),a.storyboardData.maxDate=new Date(a.storyboardEvents[c].startDate)),new Date(a.storyboardEvents[c].startDate)<a.storyboardData.minDate&&(a.storyboardData.minDate=new Date(a.storyboardEvents[c].startDate)),new Date(a.storyboardEvents[c].endDate)>a.storyboardData.maxDate&&(a.storyboardData.maxDate=new Date(a.storyboardEvents[c].endDate));a.storyboardData.minDate.setDate(a.storyboardData.minDate.getDate()-2),a.storyboardData.maxDate.setDate(a.storyboardData.maxDate.getDate()+2),a.storyboardData.minViewDate=new Date(a.storyboardData.minDate),a.storyboardData.maxViewDate=new Date((a.storyboardData.maxDate-a.storyboardData.minDate)/5+a.storyboardData.minDate.getTime()+1e6),console.log("minDate = "+a.storyboardData.minDate),console.log("maxDate = "+a.storyboardData.maxDate)};a.sliderMouseDown=!1;var c=angular.element(document.getElementById("jqSlider"));c.bind("mousestart",function(){a.sliderMouseDown=!0}),c.bind("stop",function(){a.sliderMouseDown=!1})});